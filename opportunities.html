<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”€å”®ç®¡é“ - å›å®CRM</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; margin: 0; padding: 0; background: #f8f9fa; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .crm-header { 
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%); 
            color: white; padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .logo { font-size: 24px; font-weight: bold; }
        .logo span { color: #4fc3f7; }
        .nav { display: flex; gap: 20px; }
        .nav a { color: white; text-decoration: none; padding: 5px 0; position: relative; }
        .nav a:hover::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: #4fc3f7; }
        .btn { 
            background: #4fc3f7; color: white; padding: 8px 16px; 
            border: none; border-radius: 4px; cursor: pointer;
            font-size: 14px; transition: background 0.3s;
        }
        .btn:hover { background: #03a9f4; }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219653; }
        .stage-card { 
            background: white; border-radius: 8px; padding: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px;
            border-left: 4px solid #4fc3f7;
        }
        .stage-card h3 { margin: 0 0 10px 0; color: #2c3e50; }
        .opportunity-item {
            background: #f8f9fa; border-radius: 6px; padding: 12px;
            margin-bottom: 10px; border: 1px solid #eee;
        }
        .pipeline-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .pipeline-stage {
            background: white; border-radius: 8px; padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .amount {
            font-weight: bold; color: #27ae60; font-size: 16px;
        }
        .stage-1 { border-left: 4px solid #e74c3c; }
        .stage-2 { border-left: 4px solid #e67e22; }
        .stage-3 { border-left: 4px solid #f39c12; }
        .stage-4 { border-left: 4px solid #3498db; }
        .stage-5 { border-left: 4px solid #2ecc71; }
        .stage-6 { border-left: 4px solid #9b59b6; }
        .stage-7 { border-left: 4px solid #34495e; }
    </style>
</head>
<body>
    <header class="crm-header">
        <div class="logo">å›å®<span>CRM</span></div>
        <nav class="nav">
            <a href="crm.html">ä»ªè¡¨æ¿</a>
            <a href="customers.html">å®¢æˆ·ç®¡ç†</a>
            <a href="opportunities.html" style="color: #4fc3f7;">é”€å”®ç®¡é“</a>
            <a href="tasks.html">ä»»åŠ¡ç®¡ç†</a>
            <a href="reports.html">æŠ¥è¡¨åˆ†æ</a>
            <a href="index.html">è¿”å›å®˜ç½‘</a>
        </nav>
    </header>
    
    <div class="container">
        <h1 style="color: #2c3e50; margin-bottom: 20px; font-size: 28px;">é”€å”®ç®¡é“ç®¡ç†</h1>
        
        <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="margin: 0; color: #2c3e50;">é”€å”®ç®¡é“æ€»è§ˆ</h3>
                    <p style="color: #666; margin-top: 5px;">è·Ÿè¸ªæ‰€æœ‰å•†æœºä»çº¿ç´¢åˆ°æˆäº¤çš„å…¨è¿‡ç¨‹</p>
                </div>
                <button class="btn btn-success" onclick="showAddOpportunityModal()">
                    <span style="font-size: 18px;">+</span>
                    æ–°å¢å•†æœº
                </button>
            </div>
            
            <div style="display: flex; gap: 20px; margin-top: 20px;">
                <div>
                    <span style="color: #666; font-size: 14px;">æ€»å•†æœºæ•°ï¼š</span>
                    <span style="font-size: 24px; font-weight: bold; color: #2c3e50;" id="totalOpportunities">0</span>
                </div>
                <div>
                    <span style="color: #666; font-size: 14px;">é¢„è®¡æ€»é‡‘é¢ï¼š</span>
                    <span style="font-size: 24px; font-weight: bold; color: #27ae60;" id="totalAmount">Â¥0</span>
                </div>
                <div>
                    <span style="color: #666; font-size: 14px;">æœ¬æœˆé¢„è®¡æˆäº¤ï¼š</span>
                    <span style="font-size: 24px; font-weight: bold; color: #3498db;" id="monthlyForecast">Â¥0</span>
                </div>
                <div>
                    <span style="color: #666; font-size: 14px;">å¹³å‡æˆäº¤å‘¨æœŸï¼š</span>
                    <span style="font-size: 24px; font-weight: bold; color: #9b59b6;" id="avgCycle">0å¤©</span>
                </div>
            </div>
        </div>
        
        <!-- é”€å”®ç®¡é“é˜¶æ®µ -->
        <div class="pipeline-container" id="pipelineStages">
            <!-- åŠ¨æ€åŠ è½½ç®¡é“é˜¶æ®µ -->
        </div>
        
        <div style="margin-top: 30px;">
            <h3 style="color: #2c3e50; margin-bottom: 15px;">è¿‘æœŸå•†æœº</h3>
            <div id="recentOpportunities">
                <!-- åŠ¨æ€åŠ è½½è¿‘æœŸå•†æœº -->
            </div>
        </div>
    </div>
    
    <script>
        // é”€å”®ç®¡é“æ•°æ®ç®¡ç†
        class OpportunityManager {
            constructor() {
                this.storageKey = 'junshi_crm_opportunities';
                this.stages = [
                    { id: 1, name: 'çº¿ç´¢é˜¶æ®µ', description: 'åˆæ­¥æ¥è§¦ï¼Œäº†è§£éœ€æ±‚', color: '#e74c3c' },
                    { id: 2, name: 'éœ€æ±‚ç¡®è®¤', description: 'æ·±å…¥äº†è§£å®¢æˆ·éœ€æ±‚', color: '#e67e22' },
                    { id: 3, name: 'æ–¹æ¡ˆåˆ¶å®š', description: 'åˆ¶å®šè§£å†³æ–¹æ¡ˆå’ŒæŠ¥ä»·', color: '#f39c12' },
                    { id: 4, name: 'æ–¹æ¡ˆæ¼”ç¤º', description: 'å‘å®¢æˆ·å±•ç¤ºè§£å†³æ–¹æ¡ˆ', color: '#3498db' },
                    { id: 5, name: 'å•†åŠ¡è°ˆåˆ¤', description: 'ä»·æ ¼å’Œæ¡æ¬¾è°ˆåˆ¤', color: '#2ecc71' },
                    { id: 6, name: 'åˆåŒç­¾è®¢', description: 'ç­¾è®¢åˆåŒï¼Œå‡†å¤‡å®æ–½', color: '#9b59b6' },
                    { id: 7, name: 'å·²æˆäº¤', description: 'é¡¹ç›®æˆåŠŸç­¾çº¦', color: '#34495e' }
                ];
                this.initializeSampleData();
            }
            
            initializeSampleData() {
                const existingData = localStorage.getItem(this.storageKey);
                if (!existingData) {
                    const sampleOpportunities = [
                        {
                            id: 1,
                            customerId: 1,
                            customerName: 'å¤§è¿æŸå›½ä¼',
                            name: 'ç»„ç»‡æ¶æ„ä¼˜åŒ–é¡¹ç›®',
                            amount: 50000,
                            stage: 3,
                            probability: 60,
                            expectedClose: '2026-03-15',
                            notes: 'éœ€è¦è¯¦ç»†çš„ç»„ç»‡ç»“æ„è®¾è®¡æ–¹æ¡ˆ',
                            createdAt: '2026-01-20T10:30:00Z',
                            updatedAt: '2026-02-10T14:20:00Z'
                        },
                        {
                            id: 2,
                            customerId: 2,
                            customerName: 'æŸåˆ¶é€ ä¼ä¸š',
                            name: 'æµç¨‹ä¼˜åŒ–å’¨è¯¢',
                            amount: 35000,
                            stage: 2,
                            probability: 40,
                            expectedClose: '2026-03-30',
                            notes: 'ç”Ÿäº§çº¿æ•ˆç‡æå‡é¡¹ç›®',
                            createdAt: '2026-02-01T09:15:00Z',
                            updatedAt: '2026-02-15T11:45:00Z'
                        },
                        {
                            id: 3,
                            customerId: 3,
                            customerName: 'ç§‘æŠ€å…¬å¸A',
                            name: 'æ•°å­—åŒ–è½¬å‹å’¨è¯¢',
                            amount: 80000,
                            stage: 1,
                            probability: 20,
                            expectedClose: '2026-04-10',
                            notes: 'å…¨é¢çš„æ•°å­—åŒ–æˆ˜ç•¥è§„åˆ’',
                            createdAt: '2026-02-10T14:30:00Z',
                            updatedAt: '2026-02-10T14:30:00Z'
                        }
                    ];
                    localStorage.setItem(this.storageKey, JSON.stringify(sampleOpportunities));
                }
            }
            
            getOpportunities() {
                const data = localStorage.getItem(this.storageKey);
                return data ? JSON.parse(data) : [];
            }
            
            saveOpportunities(opportunities) {
                localStorage.setItem(this.storageKey, JSON.stringify(opportunities));
            }
            
            addOpportunity(opportunity) {
                const opportunities = this.getOpportunities();
                opportunity.id = Date.now();
                opportunity.createdAt = new Date().toISOString();
                opportunity.updatedAt = new Date().toISOString();
                opportunities.push(opportunity);
                this.saveOpportunities(opportunities);
                return opportunity;
            }
            
            updateOpportunityStage(id, newStage) {
                const opportunities = this.getOpportunities();
                const index = opportunities.findIndex(o => o.id === id);
                if (index !== -1) {
                    opportunities[index].stage = newStage;
                    opportunities[index].updatedAt = new Date().toISOString();
                    this.saveOpportunities(opportunities);
                    return true;
                }
                return false;
            }
            
            deleteOpportunity(id) {
                const opportunities = this.getOpportunities();
                const filtered = opportunities.filter(o => o.id !== id);
                this.saveOpportunities(filtered);
                return filtered.length !== opportunities.length;
            }
            
            getStageName(stageId) {
                const stage = this.stages.find(s => s.id === stageId);
                return stage ? stage.name : 'æœªçŸ¥é˜¶æ®µ';
            }
            
            getStageColor(stageId) {
                const stage = this.stages.find(s => s.id === stageId);
                return stage ? stage.color : '#666';
            }
        }
        
        const opportunityManager = new OpportunityManager();
        
        // æ¸²æŸ“é”€å”®ç®¡é“
        function renderPipeline() {
            const opportunities = opportunityManager.getOpportunities();
            const pipelineContainer = document.getElementById('pipelineStages');
            const stages = opportunityManager.stages;
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateStats(opportunities);
            
            // æ¸²æŸ“æ¯ä¸ªé˜¶æ®µ
            pipelineContainer.innerHTML = stages.map(stage => {
                const stageOpportunities = opportunities.filter(o => o.stage === stage.id);
                const stageAmount = stageOpportunities.reduce((sum, o) => sum + (o.amount || 0), 0);
                const stageProbability = stageOpportunities.reduce((sum, o) => sum + (o.probability || 0), 0) / (stageOpportunities.length || 1);
                
                return `
                    <div class="pipeline-stage stage-${stage.id}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0; color: ${stage.color};">${stage.name}</h3>
                            <span style="background: ${stage.color}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px;">
                                ${stageOpportunities.length}ä¸ªå•†æœº
                            </span>
                        </div>
                        <p style="color: #666; margin: 0 0 15px 0; font-size: 14px;">${stage.description}</p>
                        <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
                            é¢„è®¡é‡‘é¢ï¼š<span style="font-weight: bold; color: #27ae60;">Â¥${stageAmount.toLocaleString()}</span>
                        </div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 15px;">
                            å¹³å‡æ¦‚ç‡ï¼š<span style="font-weight: bold; color: #3498db;">${stageProbability.toFixed(0)}%</span>
                        </div>
                        <div id="stage-${stage.id}-opportunities">
                            ${renderStageOpportunities(stageOpportunities, stage.id)}
                        </div>
                    </div>
                `;
            }).join('');
            
            // æ¸²æŸ“è¿‘æœŸå•†æœº
            renderRecentOpportunities(opportunities);
        }
        
        function renderStageOpportunities(opportunities, stageId) {
            if (opportunities.length === 0) {
                return '<div style="text-align: center; padding: 20px; color: #999; font-size: 14px;">æš‚æ— å•†æœº</div>';
            }
            
            return opportunities.map(opportunity => {
                const customerName = opportunity.customerName || 'æœªçŸ¥å®¢æˆ·';
                const amount = opportunity.amount ? `Â¥${opportunity.amount.toLocaleString()}` : 'æœªæŠ¥ä»·';
                const probability = opportunity.probability || 0;
                
                return `
                    <div class="opportunity-item">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                            <div>
                                <div style="font-weight: 500; margin-bottom: 3px;">${opportunity.name}</div>
                                <div style="font-size: 12px; color: #666;">å®¢æˆ·ï¼š${customerName}</div>
                            </div>
                            <div style="text-align: right;">
                                <div class="amount">${amount}</div>
                                <div style="font-size: 12px; color: #3498db;">æ¦‚ç‡ï¼š${probability}%</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px; margin-top: 8px;">
                            <button class="btn" onclick="viewOpportunity(${opportunity.id})" style="padding: 4px 8px; font-size: 12px; background: #ecf0f1; color: #2c3e50;">æŸ¥çœ‹</button>
                            ${stageId < 7 ? `<button class="btn" onclick="moveToNextStage(${opportunity.id}, ${stageId})" style="padding: 4px 8px; font-size: 12px; background: #27ae60;">æ¨è¿›</button>` : ''}
                            <button class="btn" onclick="deleteOpportunity(${opportunity.id})" style="padding: 4px 8px; font-size: 12px; background: #e74c3c;">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderRecentOpportunities(opportunities) {
            const recentContainer = document.getElementById('recentOpportunities');
            const recent = opportunities
                .sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))
                .slice(0, 5);
            
            if (recent.length === 0) {
                recentContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">æš‚æ— å•†æœºæ•°æ®</div>';
                return;
            }
            
            recentContainer.innerHTML = recent.map(opportunity => {
                const date = new Date(opportunity.updatedAt);
                const formattedDate = `${date.getMonth()+1}æœˆ${date.getDate()}æ—¥ ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                const stageName = opportunityManager.getStageName(opportunity.stage);
                
                return `
                    <div class="stage-card" style="border-left-color: ${opportunityManager.getStageColor(opportunity.stage)};">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">${opportunity.name}</h3>
                            <span class="amount">Â¥${opportunity.amount?.toLocaleString() || '0'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                            <div>
                                <div style="color: #666; font-size: 14px;">å®¢æˆ·ï¼š${opportunity.customerName || 'æœªçŸ¥'}</div>
                                <div style="color: #666; font-size: 14px;">é˜¶æ®µï¼š${stageName}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: #999; font-size: 12px;">æ›´æ–°ï¼š${formattedDate}</div>
                                <div style="color: #3498db; font-size: 14px; margin-top: 5px;">æ¦‚ç‡ï¼š${opportunity.probability || 0}%</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateStats(opportunities) {
            const total = opportunities.length;
            const totalAmount = opportunities.reduce((sum, o) => sum + (o.amount || 0), 0);
            const monthlyForecast = opportunities
                .filter(o => o.probability && o.probability > 50)
                .reduce((sum, o) => sum + (o.amount || 0) * (o.probability || 0) / 100, 0);
            
            document.getElementById('totalOpportunities').textContent = total;
            document.getElementById('totalAmount').textContent = `Â¥${totalAmount.toLocaleString()}`;
            document.getElementById('monthlyForecast').textContent = `Â¥${monthlyForecast.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
        }
        
        function showAddOpportunityModal() {
            const name = prompt('è¯·è¾“å…¥å•†æœºåç§°ï¼š');
            if (!name) return;
            
            const customerName = prompt('è¯·è¾“å…¥å®¢æˆ·åç§°ï¼š');
            const amountStr = prompt('è¯·è¾“å…¥é¢„è®¡é‡‘é¢ï¼ˆå…ƒï¼‰ï¼š');
            const amount = parseInt(amountStr) || 0;
            
            const opportunity = {
                name: name,
                customerName: customerName || '',
                amount: amount,
                stage: 1,
                probability: 20,
                expectedClose: '',
                notes: prompt('å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰ï¼š') || ''
            };
            
            opportunityManager.addOpportunity(opportunity);
            renderPipeline();
            alert('å•†æœºæ·»åŠ æˆåŠŸï¼');
        }
        
        function viewOpportunity(id) {
            const opportunities = opportunityManager.getOpportunities();
            const opportunity = opportunities.find(o => o.id === id);
            if (opportunity) {
                const date = new Date(opportunity.createdAt);
                const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                const stageName = opportunityManager.getStageName(opportunity.stage);
                
                alert(`ğŸ“‹ å•†æœºè¯¦æƒ…

ğŸ¯ å•†æœºåç§°ï¼š${opportunity.name}
ğŸ¢ å®¢æˆ·ï¼š${opportunity.customerName || '--'}
ğŸ’° é¢„è®¡é‡‘é¢ï¼šÂ¥${opportunity.amount?.toLocaleString() || '0'}
ğŸ“Š å½“å‰é˜¶æ®µï¼š${stageName}
ğŸ² æˆäº¤æ¦‚ç‡ï¼š${opportunity.probability || 0}%
ğŸ“… åˆ›å»ºæ—¶é—´ï¼š${formattedDate}
ğŸ“ å¤‡æ³¨ï¼š${opportunity.notes || 'æ— '}`);
            }
        }
        
        function moveToNextStage(id, currentStage) {
            if (currentStage < 7) {
                const newStage = currentStage + 1;
                if (opportunityManager.updateOpportunityStage(id, newStage)) {
                    renderPipeline();
                    alert('å•†æœºå·²æ¨è¿›åˆ°ä¸‹ä¸€é˜¶æ®µï¼');
                }
            }
        }
        
        function deleteOpportunity(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†æœºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                if (opportunityManager.deleteOpportunity(id)) {
                    renderPipeline();
                    alert('å•†æœºåˆ é™¤æˆåŠŸï¼');
                }
            }
        }
        
        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', renderPipeline);
    </script>
</body>
</html>